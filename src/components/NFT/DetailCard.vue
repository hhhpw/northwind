<template>
  <div class="nft-detail-card">
    <div class="detail-base-info">
      <div class="left-image" v-if="props.box_detail">
        <img
          v-if="state.is_blind_open"
          :src="
            (state.is_blind_open && props.box_detail.imageLink) ||
            (props.action_type === 'RECOVERY' && props.box_detail.icon)
          "
          alt=""
        />
        <div class="unopen-blind" v-else>
          <img
            :src="props.box_detail.boxTokenLogo || props.box_detail.icon"
            alt=""
          />
          <div class="unopen-blind-mask" v-if="props.action_type === 'UNSOLD'">
            <div class="unopen-blind-mask-line">
              <svg-icon
                name="left-double-arrow"
                style="font-size: 16px"
              ></svg-icon>
              <span @click="actionsCall({ action: 'OpenBlinkBox' })">
                {{ $t("打开盲盒") }}
              </span>
              <svg-icon
                name="right-double-arrow"
                style="font-size: 16px"
              ></svg-icon>
            </div>
          </div>
        </div>
      </div>
      <div class="right-info">
        <div class="right-top-bae-info">
          <div class="base-info-title">
            <span class="base-info-color" v-if="state.is_blind_open">{{
              props.box_detail.seriesName
            }}</span>
            <span class="base-info-color" v-if="!state.is_blind_open">{{
              props.box_detail.name
            }}</span>
            <span
              class="base-info-title-rarity"
              v-if="state.is_blind_open && props.box_detail?.score"
            >
              <svg-icon
                name="rarity"
                class="base-info-title-rarity-icon"
              ></svg-icon>
              <star-amount
                :value="props.box_detail?.score"
                :formatOptions="{
                  precision: 2,
                }"
              >
              </star-amount>
            </span>
          </div>

          <span class="base-info-color" v-if="state.is_blind_open">{{
            props.box_detail.name
          }}</span>
          <div class="base-info-list">
            <div class="base-info-item">
              <span class="title">{{ $t("创建者") }}</span>
              <span
                class="value"
                @click="
                  pushPage(props.box_detail.creator || props.box_detail.address)
                "
                >{{
                  stringFormat(
                    props.box_detail &&
                      (props.box_detail.creator || props.box_detail.address)
                  )
                }}</span
              >
            </div>
            <div
              class="base-info-item"
              v-if="props.box_detail && props.box_detail.owner"
            >
              <span class="title">{{ $t("当前持有者") }}</span>
              <span class="value" @click="pushPage(props.box_detail.owner)">{{
                stringFormat(props.box_detail && props.box_detail.owner)
              }}</span>
            </div>
            <div class="base-info-item">
              <span class="title">{{ $t("合约地址") }}</span>
              <span
                class="value"
                @click="pushPage(state.nft_address.split('::')[0])"
                >{{
                  state.is_blind_open
                    ? state.nft_address.slice(0, 6) +
                      "..." +
                      state.nft_address.slice(-4)
                    : stringFormat(state.nft_address)
                }}</span
              >
            </div>
          </div>
        </div>
        <!-- 操作部分 -->
        <detail-action
          class="detail-actions"
          :box_detail="props.box_detail"
          :action_type="props.action_type"
          :is_blind_open="state.is_blind_open"
          @actionsCall="actionsCall"
        ></detail-action>
      </div>
    </div>
    <div class="detail-specific-info">
      <nft-detail-tab
        :cross_bar_array="state.cross_bar_array"
        @selectCrossTab="selectCrossTab"
        :selected_tab="state.selected_tab"
      ></nft-detail-tab>
      <div class="detail-specific-info-container">
        <div
          class="specific-description"
          v-if="state.selected_tab === 'description'"
        >
          {{
            props.box_detail && state.currLang === "en"
              ? props.box_detail.enDescription
              : props.box_detail.cnDescription
          }}
        </div>
        <div
          class="specific-rarevalue"
          v-if="state.selected_tab === 'rarevalue' && state.is_blind_open"
        >
          <nft-detail-specific
            :box_detail="props.box_detail"
          ></nft-detail-specific>
        </div>
        <div
          class="specific-history"
          v-if="state.selected_tab === 'history' && state.is_blind_open"
        >
          <nft-detail-history
            :box_detail="props.box_detail"
          ></nft-detail-history>
        </div>
      </div>
    </div>
  </div>
</template>
<script setup>
import { reactive, computed, defineProps, defineEmits } from "vue";
import detailAction from "@components/NFT/DetailActions";
import NftDetailSpecific from "./NFTDetailSpecific.vue";
import SvgIcon from "@components/SvgIcon/Index.vue";
import { useStore } from "vuex";
import { useI18n } from "vue-i18n";
const { t } = useI18n();
import utilsTools from "@utils/tool";
import NftDetailHistory from "./NFTDetailHistory.vue";
import NftDetailTab from "./NFTDetailTab.vue";
import StarAmount from "@StarUI/StarAmount";

const store = useStore();
let state = reactive({
  selected_tab: "description",
  contract_address: computed(() => store.state.StoreNFTDetail.contract_address),
  accounts: computed(() => store.state.StoreWallet.accounts),
  currLang: computed(() => store.state.StoreApp.currLang),
  description: computed(() => {
    if (store.state.StoreApp.currLang == "cn") {
      return state.is_blind_open
        ? props.box_detail.cn_description
        : props.box_detail.cnDescription;
    } else {
      return state.is_blind_open
        ? props.box_detail.en_description
        : props.box_detail.enDescription;
    }
  }),
  // 盲盒是否开启
  is_blind_open: computed(() => {
    return props.blind_box_type === "nft";
  }),
  cross_bar_array: computed(() => {
    if (
      state.is_blind_open ||
      (state.history_list_params && state.history_list_params.type === "back")
    ) {
      return [
        {
          id: "description",
          name: t("描述"),
        },
        {
          id: "rarevalue",
          name: t("稀有值"),
        },
        {
          id: "history",
          name: t("历史"),
        },
      ];
    } else {
      return [
        {
          id: "description",
          name: t("描述"),
        },
      ];
    }
  }),
  nft_address: computed(() => {
    if (props.blind_box_type === "nft") {
      return `${props.box_detail.nftMeta}`;
    } else {
      return props.box_detail && props.box_detail.boxToken;
    }
  }),
});

const pushPage = (path) => {
  utilsTools.openNewWindow(`https://stcscan.io/main/address/${path}`);
};

let props = defineProps({
  box_detail: {
    type: Object,
    default: () => {},
  },
  action_type: String, // 操作类型
  blind_box_type: String, // box或是nft
  // 来源页面
  fromView: {
    type: String,
  },
});

// 操作事件回调
const emits = defineEmits(["actionsCall"]);
const actionsCall = (action) => {
  emits("actionsCall", action);
};
const stringFormat = (str) => {
  if (str) {
    return str.slice(0, 6) + "..." + str.slice(-4);
  } else {
    return "--";
  }
};

const selectCrossTab = (name) => {
  state.selected_tab = name;
};
</script>
<style lang="scss" scoped>
.nft-detail-card {
  padding-bottom: 80px;
  .detail-base-info {
    display: flex;
    justify-content: space-between;
    .left-image {
      width: 424px;
      height: 424px;
      background: #ffffff;
      border-radius: 14px;
      font-size: 0;
      overflow: hidden;
      img {
        width: 100%;
        height: 100%;
        max-width: 424px;
        max-height: 424px;
      }
      .unopen-blind {
        margin: 0 auto;
        width: 424px;
        height: 424px;
        background: rgba(235, 235, 235, 0.22);
        text-align: center;
        line-height: 424px;
        position: relative;
        .unopen-blind-mask {
          background: rgba(0, 0, 0, 0.2);
          height: 100%;
          width: 100%;
          position: absolute;
          top: 0;
          left: 0;
          .unopen-blind-mask-line {
            background: rgba(0, 0, 0, 0.5);
            color: #fff;
            width: 100%;
            height: 75px;
            font-size: 25px;
            font-weight: 600;
            position: absolute;
            top: 50%;
            transform: translate(0%, -50%);
            display: flex;
            align-items: center;
            justify-content: center;
            user-select: none;
            cursor: pointer;
            span {
              padding: 0px 20px;
            }
          }
        }
        img {
          vertical-align: middle;
          width: auto;
          height: auto;
        }
      }
    }
    .right-info {
      flex: 1;
      color: #3f1c09;
      margin-left: 33px;
      display: flex;
      flex-flow: column;
      justify-content: space-between;
      .base-info-title {
        font-size: 32px;
        font-weight: 600;
        display: flex;
        justify-content: space-between;
        align-items: center;
        .base-info-title-rarity {
          font-size: 16px;
          .base-info-title-rarity-icon {
            margin-right: 5px;
            cursor: default;
          }
        }
      }
      // .base-info-color {
      //   font-weight: 500;
      //   font-size: 20px;
      // }
      .base-info-list {
        margin-top: 24px;
        .base-info-item {
          display: flex;
          justify-content: space-between;
          margin-bottom: 8px;
          .value {
            cursor: pointer;
          }
        }
      }
      .detail-actions {
        margin-top: 24px;
      }
    }
  }
  .detail-specific-info {
    margin-top: 48px;
    color: #3f1c09;
    .detail-specific-info-container {
      margin-top: 36px;
      font-size: 14px;
      font-weight: 500;
      .specific-history {
        height: 100%;
      }
    }
  }
}
</style>
